import e from"events";import{parseObj as t,GLTexture as o,GL as r,CameraPerspective as n,OrbitalControl as s,DrawAxis as i,DrawDotsPlane as a}from"alfrid";import c from"shaders/test.vert";let l="123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ";window.fxhash="oo"+Array(49).fill(0).map((e=>l[Math.random()*l.length|0])).join("");let u=fxhash.slice(2),d=new RegExp(".{"+(fxhash.length/4|0)+"}","g"),f=u.match(d).map((e=>{return(t=e).split("").reduce(((e,o,r)=>e+l.indexOf(o)*Math.pow(l.length,t.length-r-1)),0);var t}));window.fxrand=((e,t,o,r)=>()=>{var n=((e|=0)+(t|=0)|0)+(r|=0)|0;return r=r+1|0,e=t^t>>>9,t=(o|=0)+(o<<3)|0,o=(o=o<<21|o>>>11)+n|0,(n>>>0)/4294967296})(...f);const p=[{id:"color",url:"assets/color.jpg",type:"jpg"},{id:"tree",url:"assets/tree.obj",type:"text"}];let h;const g=e=>{h=e.map((({id:e,file:r,type:n})=>{const s=r;let i;switch(n){case"jpg":case"png":i=new o(r);break;case"text":i=t(r)}return{id:e,source:s,type:n,file:i}})),console.table(h)};var m=e.EventEmitter;function v(){m.call(this),this.setMaxListeners(20)}v.prototype=Object.create(m.prototype),v.prototype.constructor=v,v.prototype.off=function(e,t){return t?this.removeListener(e,t):e?this.removeAllListeners(e):this.removeAllListeners()};var b=v,w=function(){try{return!!new Blob}catch(e){return!1}}(),y={mbs:0,secs:0,update:function(e,t,o,r){var n,s=e.getAllResponseHeaders();if(s){var i=s.match(/content-length: (\d+)/i);i&&i.length&&(n=i[1])}if(n){var a=(n=parseInt(n,10))/1024/1024,c=(Date.now()-t)/1e3;this.secs+=c,this.mbs+=a,r&&this.log(o,a,c)}else r&&console.warn.call(console,"Can't get Content-Length:",o)},log:function(e,t,o){if(e){var r="File loaded: "+e.substr(e.lastIndexOf("/")+1)+" size:"+t.toFixed(2)+"mb time:"+o.toFixed(2)+"s speed:"+(t/o).toFixed(2)+"mbps";console.log.call(console,r)}var n="Total loaded: "+this.mbs.toFixed(2)+"mb time:"+this.secs.toFixed(2)+"s speed:"+this.getMbps().toFixed(2)+"mbps";console.log.call(console,n)},getMbps:function(){return this.mbs/this.secs}},L=b,x=w,E=y,_=b,A=function(e){var t,o,r,n,s,i,a=e.id,c=e.basePath||"",l=e.url,u=e.type,d=e.crossOrigin,f=e.isTouchLocked,p=e.blob&&x,h=e.webAudioContext,g=e.log,m=function(e){e&&(i={id:a,file:e,type:u},t.emit("progress",1),t.emit("complete",i,a,u),F())},v=function(e,t){o=t||w,(r=new XMLHttpRequest).open("GET",c+l,!0),r.responseType=e,r.addEventListener("progress",b),r.addEventListener("load",o),r.addEventListener("error",M),r.send()},b=function(e){e.lengthComputable&&t.emit("progress",e.loaded/e.total)},w=function(){y()&&m(r.response)},y=function(){return r&&r.status<400?(E.update(r,n,l,g),!0):(M(r&&r.statusText),!1)},_=function(){v("json",(function(){if(y()){var e=r.response;"string"==typeof e&&(e=JSON.parse(e)),m(e)}}))},A=function(){p?k():O()},O=function(){r=new Image,d&&(r.crossOrigin="anonymous"),r.addEventListener("error",M,!1),r.addEventListener("load",T,!1),r.src=c+l},T=function(e){window.clearTimeout(s),e||!r.error&&r.readyState?m(r):M()},k=function(){v("blob",(function(){y()&&((r=new Image).addEventListener("error",M,!1),r.addEventListener("load",R,!1),r.src=window.URL.createObjectURL(r.response))}))},R=function(){window.URL.revokeObjectURL(r.src),m(r)},P=function(){h?C():D("audio")},j=function(){p?v("blob"):D("video")},C=function(){v("arraybuffer",(function(){y()&&h.decodeAudioData(r.response,(function(e){r=null,m(e)}),(function(e){M(e)}))}))},D=function(e){r=document.createElement(e),f||(window.clearTimeout(s),s=window.setTimeout(T,2e3),r.addEventListener("canplaythrough",T,!1)),r.addEventListener("error",M,!1),r.preload="auto",r.src=c+l,r.load(),f&&m(r)},M=function(e){window.clearTimeout(s);var o=e;if(r&&r.tagName&&r.error){o="MediaError: "+["","ABORTED","NETWORK","DECODE","SRC_NOT_SUPPORTED"][r.error.code]+" "+r.src}else r&&r.statusText?o=r.statusText:e&&e.message?o=e.message:e&&e.type&&(o=e.type);t.emit("error",'Error loading "'+c+l+'" '+o),S()},F=function(){t.off("error"),t.off("progress"),t.off("complete"),r&&(r.removeEventListener("progress",b),r.removeEventListener("load",o),r.removeEventListener("error",M),r.removeEventListener("load",T),r.removeEventListener("canplaythrough",T),r.removeEventListener("load",R))},S=function(){F(),r&&r.abort&&r.readyState<4&&r.abort(),r=null,h=null,i=null,window.clearTimeout(s),t.emit("destroy",a)};return t=Object.create(L.prototype,{_events:{value:{}},id:{value:e.id},start:{value:function(){switch(n=Date.now(),u){case"json":_();break;case"jpg":case"png":case"gif":case"webp":case"svg":A();break;case"mp3":case"ogg":case"opus":case"wav":case"m4a":P();break;case"ogv":case"mp4":case"webm":case"hls":j();break;case"bin":case"binary":v("arraybuffer");break;case"txt":case"text":v("text");break;default:throw"AssetsLoader ERROR: Unknown type for file with URL: "+c+l+" ("+u+")"}}},loaded:{get:function(){return!!i}},file:{get:function(){return i}},destroy:{value:S}})},O=0,T=function e(t){var o,r={},n=[],s=[],i=0,a=0,c={},l=function(r){return Array.isArray(r)?(r.forEach(l),o):((n=!!r.assets&&Array.isArray(r.assets)?e(d(r,t)):A(d(r,t))).once("destroy",g),s.push(n),c[n.id]=n,o);var n},u=function(e){return arguments.length?r[e]?r[e]:c[e]:n},d=function(e,t){"string"==typeof e&&(e={url:e});return void 0===e.isTouchLocked&&(e.isTouchLocked=t.isTouchLocked),void 0===e.blob&&(e.blob=t.blob),void 0===e.basePath&&(e.basePath=t.basePath),e.id=e.id||e.url||String(++O),e.type=e.type||function(e){return e&&e.split("?")[0].split(".").pop().toLowerCase()}(e.url),e.crossOrigin=e.crossOrigin||t.crossOrigin,e.webAudioContext=e.webAudioContext||t.webAudioContext,e.log=t.log,e},f=function(e){var t=i+e;o.emit("progress",t/a)},p=function(e,t,s){Array.isArray(e)&&(e={id:t,file:e,type:s}),i++,o.emit("progress",i/a),r[e.id]=e.file,n.push(e),o.emit("childcomplete",e),m()},h=function(e){a--,o.listeners("error").length?o.emit("error",e):console.error(e),m()},g=function(e){c[e]=null,delete c[e],r[e]=null,delete r[e],n.some((function(t,o){if(t.id===e)return n.splice(o,1),!0}))},m=function(){i>=a&&o.emit("complete",n,r,t.id,"group")};return o=Object.create(_.prototype,{_events:{value:{}},id:{get:function(){return t.id}},add:{value:l},start:{value:function(){return a=s.length,s.forEach((function(e){e.on("progress",f).once("complete",p).once("error",h).start()})),s=[],o}},get:{value:u},find:{value:function(e){if(u(e))return u(e);var t=null;return Object.keys(c).some((function(o){return!!(t=c[o].find&&c[o].find(e))})),t}},getLoader:{value:function(e){return c[e]}},loaded:{get:function(){return i>=a}},file:{get:function(){return n}},destroy:{value:function(){for(;s.length;)s.pop().destroy();return o.off("error"),o.off("progress"),o.off("complete"),n=[],r={},t.webAudioContext=null,a=0,i=0,Object.keys(c).forEach((function(e){c[e].destroy()})),c={},o.emit("destroy",o.id),o}}}),t=d(t||{},{basePath:"",blob:!1,touchLocked:!1,crossOrigin:null,webAudioContext:null,log:!1}),Array.isArray(t.assets)&&l(t.assets),o};T.stats=y;var k=T;const R=e=>{console.error(e)},P=Math.PI/180;let j=window,C=60,D=performance.now(),M=0,F=0,S=D;const U=[],I=[],B=[],N=[];let q=[],z=[],W=-1,H=0;function G(){!function(){let e,t=0,o=1e3/C,r=0;for(t=0;t<U.length;t++)e=U[t],null!=e&&e.func(e.args);for(;q.length>0;)e=q.pop(),e.func(e.args);let n=performance.now();for(F=(n-D)/1e3,M=n-S,t=0;t<I.length;t++)e=I[t],n-e.time>e.delay&&(e.func(e.args),I.splice(t,1));for(n=performance.now();B.length>0;){if(e=B.shift(),r=performance.now(),!(r-n<o)){B.unshift(e);break}e.func(e.args)}for(n=performance.now();N.length>0;)e=N.shift(),r=performance.now(),r-n<o&&e.func(e.args);S=n,q=q.concat(z),z=[]}(),W=j.requestAnimationFrame(G)}G();var J=function(e,t){const o=++H;return U[o]={func:e,args:t},o},K=function(e){return void 0!==U[e]&&(U[e]=null),-1};class X extends e{constructor(){var e;super(),console.log(((e,t)=>void 0===e?fxrand():void 0===t?fxrand()*e:e+(t-e)*fxrand())()),console.log(c),this.canvas=document.createElement("canvas"),r.init(this.canvas,{alpha:!0,preserveDrawingBuffer:!0}),this._isPlaying=!1,this._efIndex=J((()=>this._loop())),new Promise(((t,o)=>{const r=document.body.querySelector(".Loading-Bar");console.log("Load Assets",p),p.length>0?(document.body.classList.add("isLoading"),new k({assets:p}).on("error",(e=>{console.log("Error :",e)})).on("progress",(e=>{r&&(r.style.width=100*e+"%")})).on("complete",(o=>{r&&(r.style.width="100%"),g(o),setTimeout((()=>{document.body.classList.remove("isLoading"),t(e)}),500)})).start()):t(e)})).then((()=>this._onAssetsLoaded()),R)}_onAssetsLoaded(){console.log("Assets loaded"),this._initWorld()}_initWorld(){this._camera=new n,this._camera.setPerspective(70*P,r.aspectRatio,.1,50),this._orbitalControl=new s(this._camera,window,5),this._orbitalControl.rx.value=this._orbitalControl.ry.value=.3,this._dAxis=new i,this._dDots=new a,this._isPlaying=!0}play(){this._isPlaying=!0}pause(){this._isPlaying=!1}_loop(){this._isPlaying&&(this._update(),this._render())}_update(){}_render(){r.viewport(0,0,r.width,r.height),r.clear(0,0,0,1),r.setMatrices(this._camera),this._dAxis.draw(),this._dDots.draw()}resize(e,t){r.setSize(e,t),this._camera&&this._camera.setPerspective(70*P,r.aspectRatio,.1,50)}destroy(){K(this._efIndex)}}export{X as default};
